{% extends "pct/base_profile.html" %}

{% block content %}
<div class="profile-container">
  <div class="greeting-section">
    <div class="greeting">Hi, {{ profile.get_full_name }}!</div>

    <div class="profile-picture-container">
      <div class="profile-picture">
        {% if profile.profile_picture %}
          <img src="{{ profile.profile_picture.url }}" alt="Profile Picture">
        {% else %}
          <div class="profile-picture-placeholder">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>
        {% endif %}
      </div>

      <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="file" name="profile_picture" accept="image/*" id="profile-picture-input" style="display:none;" onchange="this.form.submit()">
        <button type="button" class="upload-btn" onclick="document.getElementById('profile-picture-input').click()">Upload a New Picture</button>
        <input type="hidden" name="upload_picture" value="true">
      </form>
    </div>
  </div>

  <div class="details-section">
    <div class="detail-row">
      <span class="detail-label">ROLE:</span>
      <span class="detail-value">{{ profile.role|title }}</span>
    </div>

    <div class="detail-row">
      <span class="detail-label">EMAIL:</span>
      <div id="email-display" style="display:flex;align-items:center;gap:15px;">
        <span class="detail-value">{{ profile.get_email }}</span>
        <button type="button" class="edit-btn" onclick="toggleEmailEdit()">Edit</button>
      </div>
      <div id="email-edit" style="display:none;">
        <form method="POST" id="email-form" style="display:flex;align-items:center;gap:10px;">
          {% csrf_token %}
          <input type="email" name="email" class="academic-input" value="{% if profile.email %}{{ profile.email }}{% else %}{{ user.email }}{% endif %}" placeholder="Enter new email" style="width:300px;">
          <input type="hidden" name="update_email" value="true">
          <button type="submit" class="save-btn" style="margin:0;">Save</button>
          <button type="button" class="cancel-btn" onclick="toggleEmailEdit()" style="margin:0;">Cancel</button>
        </form>
      </div>
    </div>

    <div class="detail-row">
      <span class="detail-label">NAME:</span>
      <span class="detail-value">{{ profile.get_full_name }}</span>
    </div>

    <div class="danger-section" style="margin-top:40px;padding-top:20px;border-top:1px solid #ddd;">
      <h3 style="color:#d32f2f;margin-bottom:15px;">Danger Zone</h3>
      <form method="POST" class="delete-account-form" action="{% url 'profile' %}">
        {% csrf_token %}
        <input type="hidden" name="delete_account" value="true">
        <button type="submit" class="delete-btn" style="background-color:#d32f2f;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">
          Delete My Account
        </button>
      </form>
    </div>
  </div>
</div>

<script>
function toggleEmailEdit() {
  const display = document.getElementById('email-display');
  const edit = document.getElementById('email-edit');
  display.style.display = display.style.display === 'none' ? 'flex' : 'none';
  edit.style.display = edit.style.display === 'none' ? 'flex' : 'none';
}

// Attach confirm handler to delete account form
document.addEventListener('DOMContentLoaded', function() {
  const deleteForm = document.querySelector('.delete-account-form');
  if (deleteForm) {
    deleteForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      showConfirm('Are you absolutely sure you want to delete your account? This action cannot be undone.', 'Delete Account', 'error')
        .then((confirmed) => {
          if (confirmed) {
            // Create a temporary form to ensure all data is submitted
            const formData = new FormData(form);
            const formAction = form.getAttribute('action') || form.action;
            const formMethod = form.getAttribute('method') || 'POST';
            
            // Create a temporary form and submit it
            const tempForm = document.createElement('form');
            tempForm.method = formMethod;
            tempForm.action = formAction;
            tempForm.style.display = 'none';
            
            // Copy all form data
            for (let [key, value] of formData.entries()) {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = key;
              input.value = value;
              tempForm.appendChild(input);
            }
            
            document.body.appendChild(tempForm);
            tempForm.submit();
          }
        });
    });
  }
});
</script>
{% endblock %}
